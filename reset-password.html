<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parolni Tiklash</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-blue-500 to-indigo-600 min-h-screen flex items-center justify-center p-4">

  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
    <h1 class="text-2xl font-bold text-center text-indigo-700 mb-6">Parolni Tiklash</h1>

    <!-- Step 1: Telefon -->
    <div id="step1" class="space-y-4">
      <input type="tel" id="phone" placeholder="+998901234567"
             class="w-full border border-gray-300 rounded-md px-4 py-3 focus:ring-2 focus:ring-indigo-500" />
      <button id="sendOtpBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md">
        OTP Kodni Yuborish
      </button>
    </div>

    <!-- Step 2: OTP -->
    <div id="step2" class="space-y-4 hidden">
      <input type="text" id="otp" placeholder="Kiritilgan OTP"
             class="w-full border border-gray-300 rounded-md px-4 py-3 focus:ring-2 focus:ring-indigo-500" />
      <button id="verifyOtpBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-md">
        OTP Tasdiqlash
      </button>
    </div>

    <!-- Step 3: New Password -->
    <div id="step3" class="space-y-4 hidden">
      <input type="password" id="newPassword" placeholder="Yangi Parol"
             class="w-full border border-gray-300 rounded-md px-4 py-3 focus:ring-2 focus:ring-indigo-500" />
      <button id="resetPasswordBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-md">
        Parolni Tiklash
      </button>
    </div>

    <p id="message" class="text-center mt-4 text-sm"></p>
  </div>

<script>
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  const message = document.getElementById('message');

  let phoneNumber = '';
  let otpCode = '';

  // 1 - OTP yuborish
  document.getElementById('sendOtpBtn').addEventListener('click', async () => {
    phoneNumber = document.getElementById('phone').value.trim();
    if (!phoneNumber) return showMessage('Telefon raqam kiriting', 'red');

    try {
      const res = await fetch('http://13.60.43.31:3000/verification/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'reset_password', phone: phoneNumber })
      });
      if (!res.ok) throw new Error('OTP yuborishda xatolik');
      showMessage('OTP kod yuborildi!', 'green');
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
    } catch {
      showMessage('Server bilan bog‘lanishda xatolik', 'red');
    }
  });

  // 2 - OTP tasdiqlash
  document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
    otpCode = document.getElementById('otp').value.trim();
    if (!otpCode) return showMessage('OTP kiriting', 'red');

    try {
      const res = await fetch('http://13.60.43.31:3000/verification/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'reset_password', phone: phoneNumber, otp: otpCode })
      });
      if (!res.ok) throw new Error('OTP noto‘g‘ri');
      showMessage('OTP tasdiqlandi!', 'green');
      step2.classList.add('hidden');
      step3.classList.remove('hidden');
    } catch {
      showMessage('OTP noto‘g‘ri yoki vaqti tugagan', 'red');
    }
  });

  // 3 - Parolni tiklash
  document.getElementById('resetPasswordBtn').addEventListener('click', async () => {
    const newPassword = document.getElementById('newPassword').value.trim();
    if (!newPassword) return showMessage('Yangi parol kiriting', 'red');

    try {
      const res = await fetch('http://13.60.43.31:3000/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: phoneNumber, otp: otpCode, password: newPassword })
      });
      if (!res.ok) throw new Error('Parolni tiklashda xatolik');
      showMessage('Parol muvaffaqiyatli o‘zgartirildi! Login sahifasiga yo‘naltirilmoqda...', 'green');

      setTimeout(() => {
        window.location.href = 'login.html';
      }, 2000);
    } catch {
      showMessage('Server bilan bog‘lanishda xatolik', 'red');
    }
  });

  function showMessage(text, color) {
    message.textContent = text;
    message.className = `text-center mt-4 text-${color}-600 text-sm`;
  }
</script>

</body>
</html>
